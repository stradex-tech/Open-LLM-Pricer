let csrfToken = "";

async function ensureCsrfToken() {
  if (csrfToken) return csrfToken;
  const r = await fetch("/api/csrf", { method: "GET" });
  const data = await r.json().catch(() => ({}));
  if (!r.ok) throw new Error(data?.error || `Failed to fetch CSRF token (${r.status})`);
  csrfToken = String(data?.csrfToken || "");
  if (!csrfToken) throw new Error("Missing CSRF token");
  return csrfToken;
}

async function json(url, body) {
  const token = await ensureCsrfToken();
  const r = await fetch(url, {
    method: "POST",
    headers: { "Content-Type": "application/json", "X-CSRF-Token": token },
    body: JSON.stringify(body)
  });
  const data = await r.json().catch(() => ({}));
  if (!r.ok) throw new Error(data?.error || `Request failed (${r.status})`);
  return data;
}

(async () => {
  const st = await fetch("/api/setup/status").then((r) => r.json().catch(() => ({})));
  if (st?.admin_exists) location.href = "/login";
  if (st?.setup_token_required) {
    const row = document.getElementById("setupTokenRow");
    if (row) row.classList.remove("hidden");
  }
  const warn = document.getElementById("secretWarn");
  if (warn && st?.session_secret_autogenerated) {
    warn.classList.remove("hidden");
    const persisted = Boolean(st?.session_secret_persisted);
    const el = document.getElementById("secretWarnText");
    if (el) {
      el.innerHTML = persisted
        ? `
          <code>SESSION_SECRET</code> was missing/weak/default, so the server generated a strong one and persisted it
          under <code>./data/session_secret.txt</code>. Sessions will remain valid across restarts as long as the
          <code>data/</code> folder/volume is kept.
          <div class="uMt8">
            Recommended:
            <code>cp .env.example .env</code> then
            <code>sed -i "s|^SESSION_SECRET=.*$|SESSION_SECRET=$(openssl rand -hex 32)|" .env</code>
          </div>
        `
        : `
          <code>SESSION_SECRET</code> was missing/weak/default, so the server generated one for this startup.
          It could not be persisted (check write permissions for <code>./data</code>), so sessions may reset on restart.
          <div class="uMt8">
            Recommended:
            <code>cp .env.example .env</code> then
            <code>sed -i "s|^SESSION_SECRET=.*$|SESSION_SECRET=$(openssl rand -hex 32)|" .env</code>
          </div>
        `;
    }
  }
})().catch(() => {});

document.getElementById("submit")?.addEventListener("click", async () => {
  const msg = document.getElementById("msg");
  if (msg) msg.textContent = "Working...";
  try {
    await ensureCsrfToken();
    const username = document.getElementById("username")?.value;
    const password = document.getElementById("password")?.value;
    const setupToken = document.getElementById("setupToken")?.value || "";
    await json("/api/setup/admin", { username, password, setupToken });
    location.href = "/admin";
  } catch (e) {
    const message = e instanceof Error ? e.message : String(e);
    if (msg) msg.textContent = `Error: ${message}`;
  }
});

// QoL: submit on Enter from any input.
function bindEnterToSubmit(inputId) {
  document.getElementById(inputId)?.addEventListener("keydown", (e) => {
    if (e.key !== "Enter") return;
    e.preventDefault();
    document.getElementById("submit")?.click();
  });
}
bindEnterToSubmit("setupToken");
bindEnterToSubmit("username");
bindEnterToSubmit("password");

