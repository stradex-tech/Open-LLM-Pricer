let csrfToken = "";

async function ensureCsrfToken() {
  if (csrfToken) return csrfToken;
  const r = await fetch("/api/csrf", { method: "GET" });
  const data = await r.json().catch(() => ({}));
  if (!r.ok) throw new Error(data?.error || `Failed to fetch CSRF token (${r.status})`);
  csrfToken = String(data?.csrfToken || "");
  if (!csrfToken) throw new Error("Missing CSRF token");
  return csrfToken;
}

async function json(url, body) {
  const token = await ensureCsrfToken();
  const r = await fetch(url, {
    method: "POST",
    headers: { "Content-Type": "application/json", "X-CSRF-Token": token },
    body: JSON.stringify(body)
  });
  const data = await r.json().catch(() => ({}));
  if (!r.ok) throw new Error(data?.error || `Request failed (${r.status})`);
  return data;
}

(async () => {
  const st = await fetch("/api/setup/status").then((r) => r.json().catch(() => ({})));
  if (!st?.admin_exists) location.href = "/setup";
  const warn = document.getElementById("secretWarn");
  if (warn && st?.session_secret_autogenerated) {
    warn.classList.remove("hidden");
    const persisted = Boolean(st?.session_secret_persisted);
    const el = document.getElementById("secretWarnText");
    if (el) {
      el.innerHTML = persisted
        ? `
          This server generated and persisted a session secret under <code>./data/session_secret.txt</code>.
          For full control, set <code>SESSION_SECRET</code> in a local <code>.env</code> file (see <code>.env.example</code>).
        `
        : `
          This server generated a session secret for this startup, but could not persist it (check write permissions for <code>./data</code>).
          Sessions may reset on restart. For full control, set <code>SESSION_SECRET</code> in a local <code>.env</code> file.
        `;
    }
  }
})().catch(() => {});

document.getElementById("submit")?.addEventListener("click", async () => {
  const msg = document.getElementById("msg");
  if (msg) msg.textContent = "Working...";
  try {
    await ensureCsrfToken();
    const username = document.getElementById("username")?.value;
    const password = document.getElementById("password")?.value;
    const loginAs = document.getElementById("loginAsAdmin")?.checked ? "admin" : "user";
    const res = await json("/api/auth/login", { username, password, loginAs });
    location.href = res?.user?.role === "admin" ? "/admin" : "/app";
  } catch (e) {
    const message = e instanceof Error ? e.message : String(e);
    if (msg) msg.textContent = `Error: ${message}`;
  }
});

// QoL: submit on Enter from username/password.
["username", "password"].forEach((id) => {
  document.getElementById(id)?.addEventListener("keydown", (e) => {
    if (e.key !== "Enter") return;
    e.preventDefault();
    document.getElementById("submit")?.click();
  });
});

